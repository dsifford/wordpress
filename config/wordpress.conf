# Common upstream settings
upstream php {
        # server unix:/run/php5-fpm.sock;
        server 127.0.0.1:9000;
}

upstream debug {
        # Debug Pool
        server 127.0.0.1:9001;
}

# FastCGI cache settings
fastcgi_cache_path /var/run/nginx-cache levels=1:2 keys_zone=WORDPRESS:50m inactive=60m;
fastcgi_cache_key "$scheme$request_method$host$request_uri";
fastcgi_cache_use_stale error timeout invalid_header updating http_500 http_503;
fastcgi_cache_valid 200 301 302 404 1h;
fastcgi_buffers 16 16k;
fastcgi_buffer_size 32k;
fastcgi_param SERVER_NAME $http_host;
fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
fastcgi_keep_conn on;

server {

        server_name aliemu.com   www.aliemu.com;
        access_log /var/log/nginx/aliemu.com.access.log rt_cache;
        error_log /var/log/nginx/aliemu.com.error.log;
        root /var/www/aliemu.com/htdocs;
        index index.php index.html index.htm;


        ###
        # WPFC NGINX CONFIGURATION
        ##

        set $skip_cache 0;

        # POST requests and URL with a query string should always go to php
        if ($request_method = POST) {
                set $skip_cache 1;
        }

        if ($query_string != "") {
                set $skip_cache 1;
        }

        # Don't cache URL containing the following segments
        if ($request_uri ~* "(/wp-admin/|/xmlrpc.php|wp-.*.php|index.php|/feed/|sitemap(_index)?.xml|[a-z0-9_-]+-sitemap([0-9]+)?.xml)") {
                set $skip_cache 1;
        }

        # Don't use the cache for logged in users or recent commenter
        if ($http_cookie ~* "comment_author|wordpress_[a-f0-9]+|wp-postpass|wordpress_no_cache|wordpress_logged_in") {
                set $skip_cache 1;
        }

        # Use cached or actual file if they exists, Otherwise pass request to WordPress
        location / {
                try_files $uri $uri/ /index.php?$args;
        }

        location ~ \.php$ {
                try_files $uri = 404;
                include fastcgi_params;
                fastcgi_pass php;
                fastcgi_cache_bypass $skip_cache;
                fastcgi_no_cache $skip_cache;
                fastcgi_cache WORDPRESS;
        }

        location ~ /purge(/.*) {
                fastcgi_cache_purge WORDPRESS "$scheme$request_method$host$1";
                access_log off;
        }


        ###
        # WordPress COMMON SETTINGS
        ##

        # Limit access to avoid brute force attack
        location = /wp-login.php {
                limit_req zone=one burst=1 nodelay;
                include fastcgi_params;
                fastcgi_pass php;
        }

        # Disable wp-config.txt
        location = /wp-config.txt {
                deny all;
                access_log off;
                log_not_found off;
        }
        # Disallow php in upload folder
        location /wp-content/uploads/ {
                location ~ \.php$ {
                        #Prevent Direct Access Of PHP Files From Web Browsers
                        deny all;
                }
        }

        # Yoast sitemap
        location ~ ([^/]*)sitemap(.*)\.x(m|s)l$ {
                rewrite ^/sitemap\.xml$ /sitemap_index.xml permanent;
                rewrite ^/([a-z]+)?-?sitemap\.xsl$ /index.php?xsl=$1 last;
                # Rules for yoast sitemap with wp|wpsubdir|wpsubdomain
                rewrite ^.*/sitemap_index\.xml$ /index.php?sitemap=1 last;
                rewrite ^.*/([^/]+?)-sitemap([0-9]+)?\.xml$ /index.php?sitemap=$1&sitemap_n=$2 last;
                # Following lines are options. Needed for WordPress seo addons
                rewrite ^/news_sitemap\.xml$ /index.php?sitemap=wpseo_news last;
                rewrite ^/locations\.kml$ /index.php?sitemap=wpseo_local_kml last;
                rewrite ^/geo_sitemap\.xml$ /index.php?sitemap=wpseo_local last;
                rewrite ^/video-sitemap\.xsl$ /index.php?xsl=video last;
                access_log off;
        }


        ###
        # LOCATIONS
        ##

        # Basic locations files
        location = /favicon.ico {
                access_log off;
                log_not_found off;
                expires max;
        }

        location = /robots.txt {
                try_files $uri $uri/ /index.php?$args;
                access_log off;
                log_not_found off;
        }

        # Cache static files
        location ~* \.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|css|rss|atom|js|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf|swf)$ {
                add_header "Access-Control-Allow-Origin" "*";
                access_log off;
                log_not_found off;
                expires max;
        }

        # Security settings for better privacy
        # Deny hidden files
        location ~ /\.well-known {
                allow all;
        }

        location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
        }

        # Deny backup extensions & log files
        location ~* ^.+\.(bak|log|old|orig|original|php#|php~|php_bak|save|swo|swp|sql)$ {
                deny all;
                access_log off;
                log_not_found off;
        }

        # Return 403 forbidden for readme.(txt|html) or license.(txt|html) or example.(txt|html)
        if ($uri ~* "^.+(readme|license|example)\.(txt|html)$") {
                return 403;
        }

        # Status pages
        location /nginx_status {
                stub_status on;
                access_log off;
                # include common/acl.conf; INCLUDED BELOW ALREADY
                satisfy any;
                auth_basic "Restricted Area";
                auth_basic_user_file htpasswd-ee;
                # Allowed IP Address List
                allow 127.0.0.1;
                deny all;
        }

        location ~ ^/(status|ping) {
                include fastcgi_params;
                fastcgi_pass php;
                # include common/acl.conf; INCLUDED BELOW ALREADY
                satisfy any;
                auth_basic "Restricted Area";
                auth_basic_user_file htpasswd-ee;
                # Allowed IP Address List
                allow 127.0.0.1;
                deny all;
        }

        # Adminer settings
        location /adminer {
                return 301 https://$host:22222/db/adminer;
        }

        # Add any additional configs here
        # include /var/www/aliemu.com/conf/nginx/*.conf;
}
